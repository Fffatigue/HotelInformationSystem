<div id="clients" class="container">
    <table class="table table-striped">
        <tr>
            <td><b>Client name</b></td>
            <td><b>Options</b></td>
        </tr>
        <!-- ko foreach: clients -->
        <tr>
            <td><b data-bind="text: name"></b></td>
            <td>
                <button data-bind="click: $parent.beginDetails" class="btn">Details</button>
                <button data-bind="click: $parent.remove" class="btn">Delete</button>
            </td>
        </tr>
        <!-- /ko -->
    </table>
    <button data-bind="click: beginAdd" class="btn">Add Client</button>

    <div class="w3-center">
        <div id="pagination" class="w3-bar">
            <!-- ko foreach: pagination -->
            <span data-bind="visible : isCurrentPage"><button data-bind="click: $parent.showPage"
                                                              class="w3-button w3-blue"><span
                    data-bind="text: pageNum"></span></button></span>
            <span data-bind="visible : !isCurrentPage()"><button data-bind="click: $parent.showPage"
                                                                 class="w3-button"><span
                    data-bind="text: pageNum"></span></button></span>
            <!-- /ko -->
        </div>
    </div>
</div>

<div id="addClient" class="modal hide fade" tabindex="=1" role="dialog" aria-labelledby="addDialogLabel"
     aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
        <h3 id="addDialogLabel">Add Client</h3>
    </div>
    <div class="modal-body">

        <form class="form-horizontal">
            <div class="control-group">
                <label class="control-label" for="inputClient">Client</label>
                <div class="controls">
                    <input data-bind="value: clientName" type="text" id="inputClient" placeholder="Client name"
                           style="width: 150px;">
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button data-bind="click: addClient" class="btn btn-primary">Add Client</button>
        <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
    </div>
</div>

<script>
    function ClientsViewModel() {
        var self = this;
        self.URI = 'http://localhost:8080/';
        self.clients = ko.observableArray();
        self.pagination = ko.observableArray();
        console.log("check")
        self.ajax = function (uri, method, data) {
            var request = {
                url: uri,
                type: method,
                dataType: 'json',
                contentType: "application/json",
                Accept: "application/json",
                cache: false,
                data: JSON.stringify(data)
            };
            return $.ajax(request);
        }

        self.beginAdd = function () {
            $('#addClient').modal('show');
        }

        self.beginDetails = function (client) {
            var href = '#/client/' + client.clientId();
            window.location = href
        }

        self.add = function (client) {
            self.ajax(self.URI + 'clients/', 'POST', client).done(function (data) {
                window.location.reload();
            });
        }

        self.remove = function (client) {
            self.ajax(self.URI + 'clients/id/' + client.clientId(), 'DELETE'
            ).done(function (data) {
                if (data < localStorage.getItem("page")) {
                    var href = '#/clients/' + Number(data);
                    window.location = href;
                } else {
                    window.location.reload();
                }
            });
        }

        self.showPage = function (page) {
            var href = '#/clients/' + page.pageNum();
            window.location = href;
        }


        self.ajax(self.URI + 'clients/page', 'GET').done(function (data) {
            for (var i = 1; i <= data; i++) {
                self.pagination.push({
                    pageNum: ko.observable(i),
                    isCurrentPage: ko.observable(i === Number(localStorage.getItem("page")))
                })
            }
        })

        self.ajax(self.URI + 'clients/page/' + localStorage.getItem("page"), 'GET').done(function (data) {
            for (var i = 0; i < data.length; i++) {
                self.clients.push({
                    name: ko.observable(data[i].name),
                    clientId: ko.observable(data[i].pk)
                });
            }
        });
    }

    function AddClientViewModel() {
        var self = this;
        self.URI = 'http://localhost:8080/';
        self.ajax = function (uri, method, data) {
            var request = {
                url: uri,
                type: method,
                dataType: 'json',
                contentType: "application/json",
                Accept: "application/json",
                cache: false,
                data: JSON.stringify(data)
            };
            return $.ajax(request);
        }

        self.clientName = ko.observable();

        self.addClient = function () {
            $('#addClient').modal('hide');
            clientsViewModel.add({
                name: self.clientName()

            });
            self.clientName();
        }
    }

    var clientsViewModel = new ClientsViewModel();
    var addClientViewModel = new AddClientViewModel();
    ko.applyBindings(clientsViewModel, $('#clients')[0]);
    ko.applyBindings(addClientViewModel, $('#addClient')[0]);
</script>