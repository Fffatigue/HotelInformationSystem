<div id="reservations" class="container">
    <table class="table table-striped">
        <tr>
            <td><b>Hotel name</b></td>
            <td><b>Options</b></td>
        </tr>
        <!-- ko foreach: reservations -->
        <tr>
            <td><b data-bind="text: name"></b></td>
            <td>
                <button data-bind="click: $parent.beginDetails" class="btn">Details</button>
                <button data-bind="click: $parent.remove" class="btn">Delete</button>
            </td>
        </tr>
        <!-- /ko -->
    </table>
    <button data-bind="click: beginAdd" class="btn">Add Reservation</button>

    <div class="w3-center">
        <div id="pagination" class="w3-bar">
            <!-- ko foreach: pagination -->
            <span data-bind="visible : isCurrentPage"><button data-bind="click: $parent.showPage"
                                                              class="w3-button w3-blue"><span
                    data-bind="text: pageNum"></span></button></span>
            <span data-bind="visible : !isCurrentPage()"><button data-bind="click: $parent.showPage"
                                                                 class="w3-button"><span
                    data-bind="text: pageNum"></span></button></span>
            <!-- /ko -->
        </div>
    </div>
</div>

<div id="addReservation" class="modal hide fade" tabindex="=1" role="dialog" aria-labelledby="addDialogLabel"
     aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
        <h3 id="addDialogLabel">Add Reservation</h3>
    </div>
    <div class="modal-body">

        <form class="form-horizontal">
            <div class="control-group">
                <label class="control-label" for="inputReservation">Reservation</label>
                <div class="controls">
                    <input data-bind="value: reservationName" type="text" id="inputReservation" placeholder="Reservation name"
                           style="width: 150px;">
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button data-bind="click: addReservation" class="btn btn-primary">Add Reservation</button>
        <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
    </div>
</div>

<script>
    function ReservationsViewModel() {
        var self = this;
        self.URI = 'http://localhost:8080/';
        self.reservations = ko.observableArray();
        self.pagination = ko.observableArray();

        self.ajax = function (uri, method, data) {
            var request = {
                url: uri,
                type: method,
                dataType: 'json',
                contentType: "application/json",
                Accept: "application/json",
                cache: false,
                data: JSON.stringify(data)
            };
            return $.ajax(request);
        }

        self.beginAdd = function () {
            $('#addReservation').modal('show');
        }

        self.beginDetails = function (reservation) {
            var href = '#/reservation/' + reservation.reservationId();
            window.location = href
        }

        self.add = function (reservation) {
            self.ajax(self.URI + 'reservations/', 'POST', reservation).done(function (data) {
                window.location.reload();
            });
        }

        self.remove = function (reservation) {
            self.ajax(self.URI + 'reservations/id/' + reservation.reservationId(), 'DELETE'
            ).done(function (data) {
                if (data < localStorage.getItem("page")) {
                    var href = '#/reservations/' + Number(data);
                    window.location = href;
                } else {
                    window.location.reload();
                }

            });
        }

        self.showPage = function (page) {
            var href = '#/reservations/' + page.pageNum();
            window.location = href;
        }


        self.ajax(self.URI + 'reservations/page', 'GET').done(function (data) {
            for (var i = 1; i <= data; i++) {
                self.pagination.push({
                    pageNum: ko.observable(i),
                    isCurrentPage: ko.observable(i === Number(localStorage.getItem("page")))
                })
            }
        })

        self.ajax(self.URI + 'reservations/page/' + localStorage.getItem("page"), 'GET').done(function (data) {
            for (var i = 0; i < data.length; i++) {
                self.reservations.push({
                    name: ko.observable(data[i].name),
                    reservationId: ko.observable(data[i].pk)
                });
            }
        });
    }

    function AddReservationViewModel() {
        var self = this;
        self.URI = 'http://localhost:8080/';
        self.ajax = function (uri, method, data) {
            var request = {
                url: uri,
                type: method,
                dataType: 'json',
                contentType: "application/json",
                Accept: "application/json",
                cache: false,
                data: JSON.stringify(data)
            };
            return $.ajax(request);
        }

        self.reservationName = ko.observable();

        self.addReservation = function () {
            $('#addReservation').modal('hide');
            reservationsViewModel.add({
                name: self.reservationName

            });
            self.reservationName();
        }
    }

    var reservationsViewModel = new ReservationsViewModel();
    var addReservationViewModel = new AddReservationViewModel();
    ko.applyBindings(reservationsViewModel, $('#reservations')[0]);
    ko.applyBindings(addReservationViewModel, $('#addReservation')[0]);
</script>