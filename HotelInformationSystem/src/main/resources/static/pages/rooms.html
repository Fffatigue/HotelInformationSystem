<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">

<div id="rooms" class="container">
    <table class="table table-striped">
        <tr>
            <td><b>Hotel name</b></td>
            <td><b>Room</b></td>
            <td><b>Options</b></td>
        </tr>
        <!-- ko foreach: rooms -->
        <tr>
            <td><b data-bind="text: buildingName"></b></td>
            <td><p><b>Room number </b> <span data-bind="text: roomNum"></span></p>
                <p><b>Floor number </b><span data-bind="text: floorNum"></span></p></td>
            <td>
                <button data-bind="click: $parent.beginDetails" class="btn">Details</button>
                <button data-bind="click: $parent.remove" class="btn">Delete</button>
            </td>
        </tr>
        <!-- /ko -->
    </table>
    <button data-bind="click: beginAdd" class="btn">Add Room</button>
</div>

<div id="add" class="modal hide fade" tabindex="=1" role="dialog" aria-labelledby="addDialogLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
        <h3 id="addDialogLabel">Add Room</h3>
    </div>
    <div class="modal-body">

        <form class="form-horizontal">
            <div class="control-group">
                <label class="control-label" for="inputBuilding">Building</label>
                <div class="controls">
                    <input data-bind="value: buildingName" type="text" id="inputBuilding" placeholder="Building name"
                           style="width: 150px;">
                </div>
            </div>

            <div class="control-group">
                <label class="control-label" for="inputRoom">Room</label>
                <div class="controls">
                    <input data-bind="value: roomNum" type="text" id="inputRoom" placeholder="Room number"
                           style="width: 150px;">
                </div>
            </div>

            <div class="control-group">
                <label class="control-label" for="inputFloor">Floor</label>
                <div class="controls">
                    <input data-bind="value: floorNum" type="text" id="inputFloor" placeholder="Floor number"
                           style="width: 300px;">
                </div>
            </div>

            <div class="control-group">
                <label class="control-label" for="inputPrice">Price</label>
                <div class="controls">
                    <input data-bind="value: price" type="text" id="inputPrice" placeholder="Price"
                           style="width: 300px;">
                </div>
            </div>

            <div class="control-group">
                <label class="control-label" for="inputCapacity">Capacity</label>
                <div class="controls">
                    <input data-bind="value: capacity" type="text" id="inputCapacity" placeholder="Capacity"
                           style="width: 300px;">
                </div>
            </div>

        </form>
    </div>
    <div class="modal-footer">
        <button data-bind="click: addRoom" class="btn btn-primary">Add Room</button>
        <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
    </div>
</div>

<script>
    function RoomsViewModel() {
        var self = this;
        self.roomsURI = 'http://localhost:8080/rooms';
        self.rooms = ko.observableArray();

        self.ajax = function (uri, method, data) {
            var request = {
                url: uri,
                type: method,
                dataType: 'json',
                contentType: "application/json",
                Accept: "application/json",
                cache: false,
                data: JSON.stringify(data)
            };
            return $.ajax(request);
        }

        self.beginAdd = function () {
            $('#add').modal('show');
        }

        self.beginDetails = function(room){
            localStorage.setItem("buildingName", room.buildingName());
            localStorage.setItem("floorNum", room.floorNum());
            localStorage.setItem("roomNum", room.roomNum());
            var href = '#building/'+room.buildingName()+'/floor/' + room.floorNum() + '/room/' + room.roomNum();
            window.location = href
        }

        self.add = function (room) {
            self.ajax(self.roomsURI, 'POST', room).done(function (data) {
                self.rooms.push({
                    roomNum: ko.observable(data.room.roomNum),
                    floorNum: ko.observable(data.room.floorNum),
                    buildingName: ko.observable(data.room.buildingName),
                    capacity: ko.observable(data.room.capacity),
                    price: ko.observable(data.room.price)
                });
            });
        }

        self.remove = function (room) {
            self.ajax(self.roomsURI, 'DELETE', room).done(function () {
                self.rooms.remove(room);
            });
        }

        self.ajax(self.roomsURI, 'GET').done(function (data) {
            for (var i = 0; i < data.length; i++) {
                self.rooms.push({
                    roomNum: ko.observable(data[i].roomNum),
                    floorNum: ko.observable(data[i].floorNum),
                    buildingName: ko.observable(data[i].buildingName)
                });
            }
        });
    }

    function AddRoomViewModel() {
        var self = this;
        self.roomNum = ko.observable();
        self.floorNum = ko.observable();
        self.buildingName = ko.observable();
        self.price = ko.observable();
        self.capacity = ko.observable();
        self.addRoom = function () {
            $('#add').modal('hide');
            roomsViewModel.add({
                roomNum: self.roomNum(),
                floorNum: self.floorNum(),
                buildingName: self.buildingName(),
                price: self.price(),
                capacity: self.capacity()

            });
            self.roomNum("");
            self.floorNum("");
            self.buildingName("");
            self.capacity("");
            self.price("");
        }
    }

    var roomsViewModel = new RoomsViewModel();
    var addRoomViewModel = new AddRoomViewModel();
    ko.applyBindings(roomsViewModel, $('#rooms')[0]);
    ko.applyBindings(addRoomViewModel, $('#add')[0]);
</script>
